#!/bin/bash -e
# shellcheck disable=SC2046,SC2068,SC2064,SC2086

HUB_HOME=${HUB_HOME:-$(dirname "$0")}

usage() {
  cat << EOF
Reads configuration information in $HUB_FILES and configures stack for deployment

Use: 
  hub configure -f hub.yaml <parameters>

Common parameters:
  -f  --file              Path to stack definition file (can be repeated multiple times)
  -r  --requirement       Configure one requirement (can be repeated multiple times)
  -s  --silent            Suppress console outputs in favor of result codes
  -V  --verbose           Verbose outputs for debug purposeEOF
  -h  --help              Print this message

Use: hub configure -r aws -r kubernetes   # to configure just one requirement 

Usage for stack requirements: [$(echo "$1" | xargs)]

EOF
  for req in $1; do
    if echo "$2" | grep -oh "\w*$req\w*"; then
      continue
    fi
    local configure
    if test -f "$WORKDIR/.hub/$req/configure"; then
      configure="$WORKDIR/.hub/$req/configure"
    elif test -f "$HUB_HOME/$req/configure"; then
      configure=$HUB_HOME/$req/configure
    else
      continue
    fi
    $configure --help
  done
}

# find_up () {
#   path=$(pwd)
#   while [[ "$path" != "" && ! -e "$path/$1" ]]; do
#     path=${path%/*}
#   done
#   echo "$path/$1"
# }

VERBOSE=false
SILENT=false
HELP=false
ARGS=$*
HUB_FILES=""
HUB_DEPLOY_PROFILE="pod"
dotenv=$HUB_HOME/env/dotenv

if test -f ".env"; then
  set +a
  eval $($dotenv export -f ".env" )
  set -a
fi

while [ "$1" != "" ]; do
  case $1 in
    -f | --file ) 
      shift
      HUB_FILES=$(echo "$HUB_FILES $1" | xargs)
      ;;
    # -C | --workdir ) 
    #   shift
    #   WORKDIR=$1
    #   ;;             
    -r | --requirement ) 
      shift 
      REQS=$(echo "$REQS $1" | xargs)
      ;;
    -S | --silent )
      SILENT=true
      ;;
    -V | --verbose )
      VERBOSE=true
      ;;
    -h | --help )        
      HELP=true
      ARGS="--help"
      ;;
  esac
  shift
done

if $VERBOSE; then
  set -x
fi

if test -z "$HUB_FILES"; then
  cat << EOF

Error: cannot find hub definition files

Full usage info:
  hub configure -f hub.yaml --help

Example:
  hub configure -f hub.yaml

EOF
  exit 1
fi

TEMP_FILES=""
temp_file(){
  local temp
  temp=$(mktemp) || exit 1
  TEMP_FILES="$TEMP_FILES $temp"
  echo $temp
}

download_file() {
  if test -f "$2"; then
    return
  fi

  local temp http_code
  temp=$(temp_file)
  echo "  Downloading $(basename $2) from: $1"
  http_code=$(
    curl -sLo "$temp" -w "%{http_code}" "$1"
  )
  if test "$(echo $http_code | cut -c1-1)" != "2"; then
    echo "Error downloading url: $http_code"
    cat $temp
    return $http_code
  fi
  if test ! -s "$temp"; then
    echo "Error: have got empty file (url: $temp)"
    return 1
  fi
  echo -n "  Saving to $(pwd): "
  $HUB_HOME/env/copy "$temp" "$2"
}

KNOWN_URLS=""
EXPANDED=""
expand_hub_files() {
  local f included local_file
  for f in $@; do 
    if grep -q "$f" <<< "$EXPANDED"; then 
      continue
    fi
    if test -f "$f"; then
      EXPANDED=$(echo "$EXPANDED $f" | xargs)
      $HELP || echo "* File $(basename $f): exist"
      included=$(yq r "$f" -j | jq -r '.extensions.include|select(.)[]')
      if test -n "$included"; then
        expand_hub_files $included
      fi
      continue
    fi
    # is url
    if echo "$f" | grep -e '^https\?://' >/dev/null 2>&1; then
      local_file="$WORKDIR/$(basename "$f")"
      if test ! -f "$local_file"; then
        download_file "$f" "$local_file"
        KNOWN_URLS=$(dirname $f | xargs)
      fi
      expand_hub_files "$local_file"
      continue
    fi

    for url in $KNOWN_URLS; do
      # shellcheck disable=SC2001
      if download_file "$url/$1" "$WORKDIR/$1"; then
        expand_hub_files "$WORKDIR/$1"
        break
      fi
    done

    if test ! -f "$f"; then
      echo "Error: $f not found!"
      exit 1
    fi
  done
}

update_symlink() {
  if test -L "$2" && test $(readlink -n "$2") != "$1"; then
    unlink "$2"
  fi
  if test ! -f ".env"; then
    ln -sf "$1" "$2"
    echo "* Updated .env link to $(basename $1)"
  fi
}

finalize() {
  # shellcheck disable=SC2046
  local rv=$?
  local profiles
  if test -d "$WORKDIR/.hub/profiles"; then profiles="$profiles $(ls "$WORKDIR/.hub/profiles")"; fi
  if test -d "$HUB_HOME/profiles"; then profiles="$profiles $(ls $HUB_HOME/profiles)"; fi
  echo "Finalizing env files..."
  TEMP1=$(temp_file)
  TEMP2=$(temp_file)
cat << EOF >> $TEMP2
  # stack definition files
  HUB_FILES="$HUB_FILES"
  # deploy options can be: $(echo "$profiles" | xargs)
  HUB_DEPLOY_PROFILE="$HUB_DEPLOY_PROFILE"
EOF
  MERGE_FILES="$MERGE_FILES -f $TEMP2"
  # shellcheck disable=SC2001
  $dotenv merge $MERGE_FILES > $TEMP1
  HUB_DOMAIN_NAME=$($dotenv -f "$TEMP1" get "HUB_DOMAIN_NAME" --default "$HUB_DOMAIN_NAME")
  echo -n "* Saving configuration to .hub/env/$HUB_DOMAIN_NAME.env: "
  $HUB_HOME/env/copy "$TEMP1" "$WORKDIR/.hub/env/$HUB_DOMAIN_NAME.env"
  update_symlink "$WORKDIR/.hub/env/$HUB_DOMAIN_NAME.env" "$WORKDIR/.env"
  echo 
  if test "$rv" = "0"; then
    echo "Done!"
  else
    echo "See error above!"
  fi
  exit $rv
}

if test -z "$WORKDIR"; then
  first=$(echo "$HUB_FILES" | awk '{print $1;}')
  if test -f $first; then
    WORKDIR=$(dirname "$FIRST_FILE")
  else
    WORKDIR=$(pwd)
  fi
fi

if test ! -d $WORKDIR; then
  mkdir -p "$WORKDIR"
fi

$HELP || echo "Checking hub files:"
expand_hub_files $HUB_FILES
HUB_FILES="$EXPANDED"
mkdir -p "$WORKDIR/.hub/env"
# common environment variables that 
# will be used by exact extensions
export WORKDIR SILENT VERBOSE HUB_FILES HUB_HOME
if test -z "$REQS"; then
  for f in $HUB_FILES; do
    test -f $f || continue;
    REQS="$REQS $(yq r "$f" -j | jq -r '.extensions.configure? | select(.)[]')"
  done
  REQS=$(echo "$REQS" | xargs -n1)
fi

if test -z "$ARGS" || $HELP; then
  usage "$REQS"
  exit
fi

trap 'finalize $?' EXIT

MERGE_FILES=""
if test -f "$WORKDIR/.env"; then
  echo "Reading .env file: "
  set +a
  eval $($dotenv export -f "$WORKDIR/.env" )
  set -a
  if test -n "$HUB_CLOUD_PROVIDER"; then echo "Cloud provider: $HUB_CLOUD_PROVIDER"; fi
  if test -n "$HUB_DOMAIN_NAME"; then echo "Stack domain name: $HUB_DOMAIN_NAME"; fi
  if test -L "$WORKDIR/.env"; then
    MERGE_FILES="-f $(readlink -n "$WORKDIR/.env")"
  else 
    MERGE_FILES="-f $WORKDIR/.env"
  fi
else
  echo "to be created"
fi

for req in $(echo "$REQS" | xargs -n1); do
  if test -f "$WORKDIR/.hub/$req/configure"; then
    configure="$WORKDIR/.hub/$req/configure"
  elif test -f "$HUB_HOME/$req/configure"; then
    configure=$HUB_HOME/$req/configure
  else
    echo "* Cannot find configure script for "$req": skipping"
    continue
  fi
  TEMP=$(temp_file)
  if ! $configure --output "$TEMP" $ARGS; then
    cat << EOF

Error: "$req" completed with error!

For trouble shooting:
  hub configure -r "$req" --verbose

For additional options:
  hub configure -r "$req" --help

EOF
    exit 4
  fi
  if test -s "$TEMP"; then
    set +a
    eval $($dotenv export -f "$TEMP")
    set -a
    MERGE_FILES="$MERGE_FILES -f $TEMP"
  fi
done
