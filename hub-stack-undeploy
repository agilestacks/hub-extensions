#!/bin/bash -e
# shellcheck disable=SC2086

usage() {
cat << EOF

Deploys this stack

Usage: 
$ $(basename "$0")

Deploys all components

$ $(basename "$0") -c component1,component2
Deploys deploys two components 

Parameters:
    -c --component     List of components to deploy
    -o --offset        Deploy starting with the given component
    -s  --silent          Suppress console outputs in favor of result codes
    --skip-guide          Suppress "What's next messages"
    -V  --verbose         Verbose outputs for debug purpose
    -h  --help            Print this message

EOF
}

SILENT=false
while [ "$1" != "" ]; do
    case $1 in
        -c | --component )  shift
                            HUB_UNDEPLOY_OPTS="$HUB_UNDEPLOY_OPTS -c $1"
                            ;;
        -o | --offset )     shift
                            HUB_UNDEPLOY_OPTS="$HUB_UNDEPLOY_OPTS -o $1"
                            ;;
        -S | --silent )     SILENT=true
                            ;;
        -V | --verbose )    set -x
                            export HUB_TRACE=1
                            export HUB_DEBUG=1
                            ;;
        -h | --help )       usage
                            exit
                            ;;
        * )                 usage
                            exit 1
    esac
    shift
done

if ! test -f .env; then
  $SILENT || cat << EOF
Configuration has not been found. Run 

$ hub configure --kubecontext <kubecontext>

EOF
  exit 1
fi
# shellcheck disable=SC1091
source .env

HUB_ELABORATE_FILE="${HUB_ELABORATE_FILE:-".hub/$HUB_DOMAIN_NAME.elaborate"}"
HUB_STATE_FILE="${HUB_STATE_FILE:-".hub/$HUB_DOMAIN_NAME.state"}"
HUB_UNDEPLOY_OPTS="--force --clouds=aws $HUB_UNDEPLOY_OPTS"

cat << EOF
Undeploying: $HUB_DOMAIN_NAME"

Warning: this operation cannot be reverted! It may lead to data loss!

EOF

$SILENT || echo "* Using cluster: $HUB_DOMAIN_NAME"
if ! test -f "$HUB_ELABORATE_FILE"; then
  $SILENT || echo "Error: cannot find hub elaborate file: $HUB_ELABORATE_FILE"
  exit 2
fi

$SILENT || echo "* Using hub elaborate file: $HUB_ELABORATE_FILE"

if test -f "$HUB_STATE_FILE"; then
  HUB_UNDEPLOY_OPTS="$HUB_UNDEPLOY_OPTS -s $HUB_STATE_FILE"
  $SILENT || echo "* Using hub state file: $HUB_STATE_FILE"  
fi

cat <<EOF

### Proceed with undeploy operation

EOF

hub undeploy $HUB_UNDEPLOY_OPTS "$HUB_ELABORATE_FILE"
