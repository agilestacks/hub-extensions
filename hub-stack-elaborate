#!/bin/bash -e

usage() {
cat << EOF

Runs reconciliation for all parameters of this stack components
and this stack prerequisites

Usage: 
$ hub stack deploy

Parameters:
    -V  --verbose          Verbose outputs for debug purpose
    -h --help              Show this message

EOF
}

while [ "$1" != "" ]; do
    case $1 in
    -V | --verbose )    set -x
                        ;;
    -h | --help )       usage
                        exit
                        ;;
    * )                 usage
                        exit 1
    esac
    shift
done

echo "Reconciling deployment plan for $HUB_DOMAIN_NAME"

if [[ ! -f .env ]]; then
  echo "* Error: configuration '.env' has not been found" 
  exit 1
fi
dotenv=$(dirname "$0")/env/dotenv
set +a
eval "$($dotenv export -f ".env" )"
set -a
echo "* Using domain name: $HUB_DOMAIN_NAME"

if test -z "$HUB_FILES"; then
  cat << EOF 
Error: cannot find hub definition files (HUB_FILES)"

Probably because stack has not been configured for deployment yet!

Example:
  $ hub configure -f hub.yaml -f params.yaml

EOF

  exit 2
fi

HUB_ELABORATE_FILE="${HUB_ELABORATE_FILE:-".hub/$HUB_DOMAIN_NAME.elaborate"}"
HUB_STATE_FILE="${HUB_STATE_FILE:-".hub/$HUB_DOMAIN_NAME.state"}"

if test -f "$HUB_STATE_FILE"; then
  echo "* Using hub state file: $HUB_STATE_FILE"
  HUB_ELABORATE_OPTS="$HUB_ELABORATE_OPTS -s $HUB_STATE_FILE"
fi

if test -n "$HUB_CLOUD_PROVIDER"; then
  HUB_DEPLOY_OPTS="--clouds=$HUB_CLOUD_PROVIDER $HUB_DEPLOY_OPTS"
fi

# shellcheck disable=SC2086
hub elaborate $HUB_FILES -o "$HUB_ELABORATE_FILE" $HUB_ELABORATE_OPTS 
echo "* Result saved to to: $HUB_ELABORATE_FILE"
